<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Physik Battle</title>
<style>
    body {
        background-color: black;
        color: #00ff00;
        font-family: "Courier New", monospace;
        padding: 20px;
        white-space: pre-line;
    }
    input {
        background-color: black;
        border: 1px solid #00ff00;
        color: #00ff00;
        font-family: "Courier New", monospace;
        padding: 5px;
        width: 200px;
    }
</style>
</head>
<body>

<pre id="gameText"></pre>
<input id="inputField" autocomplete="off">

<script>
let gameText = document.getElementById("gameText");
let inputField = document.getElementById("inputField");

// --- Grundmechanik ---
let players = ["stefan", "felix"];
let currentPlayerIndex = 0;
let level = 1;
let targetDistance = 0;
let ballSize = "";
let dragFactor = 1.0;
let heightDifference = 0;
let score = { stefan: 0, felix: 0 };

let state = "intro";
let pendingRandomGiven = null;

// --- Hilfsfunktionen ---
function log(t) {
    gameText.textContent += t + "\n";
}

function waitForInput(nextState) {
    state = nextState;
    inputField.value = "";
    inputField.focus();
}

// --- Physik ---
function computeDistance(x, y, drag, height) {
    let g = 9.81;
    let time;

    if (height === 0) {
        time = (2 * y) / g;
    } else {
        // Wurf von Höhe h (vereinfachte Näherung)
        time = (y + Math.sqrt(y*y + 2*g*(-height))) / g;
    }

    if (time < 0) time = 0;

    let distance = x * time * drag;
    return Math.round(distance);
}

function startLevel() {
    log("\n===============================");
    log("              LEVEL " + level);
    log("===============================\n");

    // Münzwurf
    currentPlayerIndex = Math.random() < 0.5 ? 0 : 1;
    log("Eine Münze entscheidet... " + players[currentPlayerIndex] + " beginnt!\n");

    // Ballgröße
    let sizes = [
        {name: "kleinen Ball", drag: 0.97},
        {name: "mittleren Ball", drag: 0.90},
        {name: "riesigen Ball", drag: 0.70}
    ];
    let b = sizes[Math.floor(Math.random() * 3)];
    ballSize = b.name;
    dragFactor = b.drag;

    // Distanz
    targetDistance = Math.floor(Math.random()*91 + 10);

    // Höhe je nach Level
    if (level === 3 || level === 6) {
        heightDifference = Math.floor(Math.random()*31 + 10); 
    } else {
        heightDifference = 0;
    }

    // Szene
    if (level === 1) {
        log("Szene: Ihr steht auf einer vollkommen ruhigen Ebene im leeren Raum.");
        log("Magiebälle funktionieren auch im Vakuum!");
    }
    if (level === 2) {
        log("Szene: Ein mächtiger Windgeist erwacht. Luft ist plötzlich überall!");
        log("Mit Luftwiderstand!");
    }
    if (level === 3) {
        log("Szene: Ihr steht auf einem hohen Turm. Unter euch gähnt der Abgrund.");
        log("Im Vakuum – kein Luftwiderstand.");
    }
    if (level === 4) {
        log("Szene: Ein alter Magier verrät euch einen Teil der Lösung…");
        log("Keine Luft, flache Ebene.");
    }
    if (level === 5) {
        log("Szene: Der Magier flüstert wieder einen Wert… doch diesmal in Luft!");
    }
    if (level === 6) {
        log("Szene: Der Magier steht auf eurem Turm und ruft euch einen Wert zu!");
        log("Vakuum, aber mit Höhenunterschied.");
    }

    log("\nZieldistanz: " + targetDistance + " m");
    log("Ihr werft einen " + ballSize + " (Drag: " + (dragFactor*100).toFixed(0) + "%)\n");

    // Random Vorgaben abhängig vom Level (4–6)
    if (level >= 4) {
        if (Math.random() < 0.5) {
            pendingRandomGiven = "x";
            let r = Math.floor(Math.random()*46 + 5);
            log("Der Magier sagt euch: x = " + r + " m/s ist FIX!");
            log("Berechne y so, dass du triffst!\n");
            currentX = r;
            waitForInput("askYonly");
        } else {
            pendingRandomGiven = "y";
            let r = Math.floor(Math.random()*46 + 5);
            log("Der Magier ruft: y = " + r + " m/s ist SCHICKSAL!");
            log("Berechne x passend dazu!\n");
            currentY = r;
            waitForInput("askXonly");
        }
    } else {
        pendingRandomGiven = null;
        askX();
    }
}

let currentX = null;
let currentY = null;

// --- Eingabe-Ablauf ---
function askX() {
    log("\n--- " + players[currentPlayerIndex] + " ist am Zug ---");
    log(players[currentPlayerIndex] + ", gib x-Geschwindigkeit ein:");
    waitForInput("inputX");
}

function askY() {
    log("Jetzt y:");
    waitForInput("inputY");
}

function evaluateThrow() {
    let dist = computeDistance(currentX, currentY, dragFactor, -heightDifference);
    let diff = dist - targetDistance;

    if (diff === 0) {
        log("\n★★ PERFEKTER TREFFER! ★★");
        score[players[currentPlayerIndex]] += level;
        log(players[currentPlayerIndex] + " bekommt " + level + " Punkte!\n");
        nextLevel();
        return;
    }

    if (diff > 0) {
        log("\n→ Der Ball war " + diff + " m zu WEIT.");
    } else {
        log("\n→ Der Ball war " + Math.abs(diff) + " m zu KURZ.");
    }

    // Spielerwechsel
    currentPlayerIndex = 1 - currentPlayerIndex;

    // Je nach Level wieder x->y oder spezielle Eingabe
    if (pendingRandomGiven === "x") {
        waitForInput("askYonly");
    } else if (pendingRandomGiven === "y") {
        waitForInput("askXonly");
    } else {
        askX();
    }
}

function nextLevel() {
    level++;
    if (level > 6) {
        log("Spiel ENDE! Punkte:");
        log("stefan: " + score.stefan);
        log("felix: " + score.felix);
        return;
    }
    startLevel();
}

// --- Input Handler ---
inputField.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        let val = inputField.value.trim();

        if (state === "intro") {
            log("Willkommen zum Physik-Battle!\n");
            startLevel();
        }

        else if (state === "inputX") {
            currentX = parseFloat(val);
            askY();
        }

        else if (state === "inputY") {
            currentY = parseFloat(val);
            evaluateThrow();
        }

        else if (state === "askXonly") {
            currentX = parseFloat(val);
            evaluateThrow();
        }

        else if (state === "askYonly") {
            currentY = parseFloat(val);
            evaluateThrow();
        }
    }
});
</script>

</body>
</html>
